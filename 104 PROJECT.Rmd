---
title: "Econ 104 Course Project"
author: "Valeria Meza, Brianna Pineda, Sara Hameed"
date: "2026-02-11"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(tidyverse)
library(Boruta)
library(car)
library(lmtest)
library(sandwich)
library(tseries)
library(boot)
library(caret)

set.seed(123)
```

```{r load-data}
df <- read_csv("data/msa_housing_final.csv")
nrow(df)
glimpse(df)
```

```{r create-employment-rate}
# Create employment_rate if missing (so you have 10 predictors)
if (!"employment_rate" %in% names(df)) {
  df <- df %>% mutate(employment_rate = 1 - unemployment_rate)
}

"employment_rate" %in% names(df)
```


```{r define-vars}
y_var <- "med_home_value"

quant_vars <- c(
  "med_income",
  "log_income",
  "population",
  "log_population",
  "unemployment_rate",
  "employment_rate",
  "med_age",
  "age_squared",
  "vacancy_rate",
  "college_share"
)

cat("Missing variables:", setdiff(c(y_var, quant_vars), names(df)), "\n")
```
## Introduction
(put your intro paragraph here)

## 1. Economic Theory and Hypothesis
### (a) Research Question
### (b) Economic Theory
### (c) Hypotheses
### (d) Expected Signs


## 2. Variable Selection 
### (a) Boruta Algorithm (Quantitative Predictors)  
```{r boruta}
boruta_df <- df %>%
  select(all_of(c(y_var, quant_vars))) %>%
  drop_na()

X <- boruta_df %>% select(all_of(quant_vars))
y <- boruta_df[[y_var]]

set.seed(123)
boruta_fit <- Boruta(x = X, y = y, doTrace = 1, maxRuns = 100)
boruta_fixed <- TentativeRoughFix(boruta_fit)

confirmed <- getSelectedAttributes(boruta_fixed, withTentative = FALSE)
confirmed

plot(boruta_fixed, las = 2, cex.axis = 0.7)
```
We applied the Boruta algorithm to identify the most relevant quantitative predictors of median home value across U.S. metropolitan statistical areas. The algorithm compares the importance of each predictor to randomized shadow variables and retains only those that consistently outperform the shadows. Using 100 iterations and a fixed random seed for reproducibility, Boruta confirmed all ten candidate quantitative predictors as important. These include measures of income, population size, labor market conditions, demographic structure, housing market tightness, and educational attainment.

### (b) Factor/indicator variables
```{r create-indicators}

# -----------------------------
# Create Indicator Variables
# -----------------------------

# 1. High-income MSA (above median income)
income_cutoff <- median(df$med_income, na.rm = TRUE)

df <- df %>%
  mutate(
    high_income_msa = ifelse(med_income > income_cutoff, 1, 0)
  )

table(df$high_income_msa)


# 2. Large MSA (above median population)
population_cutoff <- median(df$population, na.rm = TRUE)

df <- df %>%
  mutate(
    large_msa = ifelse(population > population_cutoff, 1, 0)
  )

table(df$large_msa)


# 3. Tight housing market (below median vacancy rate)
vacancy_cutoff <- median(df$vacancy_rate, na.rm = TRUE)

df <- df %>%
  mutate(
    tight_market = ifelse(vacancy_rate < vacancy_cutoff, 1, 0)
  )

table(df$tight_market)
```

```{r define-factor-vars}

factor_vars <- c(
  "high_income_msa",
  "large_msa",
  "tight_market"
)

factor_vars
```
The dataset did not contain existing categorical predictors beyond the MSA name. Therefore, we constructed economically meaningful binary indicators. We created a high-income MSA indicator (above the median income), a large metropolitan area indicator (above median population), and a tight housing market indicator (below median vacancy rate). These variables allow us to test whether structural differences across metropolitan areas are associated with variation in housing prices. 

### (c) Final predictor set
```{r final-predictor-set}

final_predictors <- c(quant_vars, factor_vars)

final_predictors
```

## 3. Descriptive Analysis and EDA
###(a) Provide detailed description of your dataset: source, time period, sample selection, vari- able definitions 
We are analyzing the cross-sectional variation in housing prices across various U.S. Metropolitan Statistical Areas (MSAs) using the American Community Survey (ACS) 5-Year Estimates for 2019-2023. The unit we are observing is the MSA and the final sample includes 393 MSAs. There are no missing values for the outcome variable. The dependent variable is the median home value (med_home_value). We are using the explanatory variables to capture local economic conditions, market size, housing market tightness, and demographic/human capital composition. A few variables are transformed to explain non-linearity and scale differences. 

Variable Definitions on MSA level: 
-med_home_value: median value of owner-occupied housing units (outcome) 
-med_income: median household income 
-population: total population 
-unemployment_rate: unemployed / labor_force 
-employment_rate: 1 − unemployment_rate (constructed) 
-vacancy_rate: vacant_units / housing_units 
-college_share: college_grad / college_total 
-med_age: median age 
-log_income: ln(med_income)
-log_population: ln(population) 
-age_squared: med_age² 

###(b) Begin by providing a descriptive analysis of your variables. This should include things like histograms, quantile plots, correlation plots, boxplots, scatterplots, etc.
```{r eda-vars}
# Outcome + predictors you decided to keep
eda_vars <- c(
  y_var,
  "med_income","log_income",
  "population","log_population",
  "unemployment_rate","employment_rate",
  "med_age","age_squared",
  "vacancy_rate","college_share"
)

# Keep only numeric columns (should be all of them here)
eda_vars <- eda_vars[eda_vars %in% names(df)]
eda_vars
```
###STEP 1 — Histograms (univariate)
```{r eda-histograms}
df_long <- df %>%
  dplyr::select(all_of(eda_vars)) %>%
  pivot_longer(cols = everything(), names_to = "variable", values_to = "value")

ggplot(df_long, aes(x = value)) +
  geom_histogram(bins = 30) +
  facet_wrap(~variable, scales = "free") +
  labs(title = "Histograms of Outcome and Predictors")
```

###STEP 2 — Quantile plots (QQ plots)
```{r eda-qqplots}
ggplot(df_long, aes(sample = value)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~variable, scales = "free") +
  labs(title = "QQ Plots (Normality Check)")
```

###STEP 3 — Correlation plot (multivariate)
```{r eda-correlation}
num_df <- df %>% dplyr::select(all_of(eda_vars)) %>% drop_na()

cor_mat <- cor(num_df)
round(cor_mat, 3)
```
```{r eda-corr-plot}
GGally::ggcorr(num_df, label = TRUE, label_round = 2) +
  labs(title = "Correlation Plot (Numeric Variables)")
```

### STEP 4 — Boxplots
```{r eda-boxplots}
ggplot(df_long, aes(x = variable, y = value)) +
  geom_boxplot() +
  coord_flip() +
  labs(title = "Boxplots (Outliers / Spread Check)")
```
### STEP 5 — Scatterplots vs the outcome (med_home_value)
```{r eda-scatter-outcome}
predictors <- setdiff(eda_vars, y_var)

for (v in predictors) {
  p <- ggplot(df, aes(x = .data[[v]], y = .data[[y_var]])) +
    geom_point(alpha = 0.5) +
    geom_smooth(method = "lm", se = FALSE) +
    labs(title = paste("Scatter:", y_var, "vs", v),
         x = v, y = y_var)
  print(p)
}
```
-Histograms depict the distribution shape and show if logs help. 
-QQ Plots check for normality and flag extreme tails and outliers.
-Correlation Plots highlight multicollinearity. 
-Boxplots show outliers and variables that are dispersed in an unusual way. 
-Scatterplots vs. med_home_value shows the direction and possible nonlinear patterns that motivate transformations. 


## 4. Model Building and Selection
## 5. Diagnostics and Robustness
## 6. Results and Economic Interpretation
## 7. Limitations and Extensions
## 8. Code Quality and Reproducibility




